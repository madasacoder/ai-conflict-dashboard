<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Simple Workflow Builder Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
      #drawflow {
        width: 100%;
        height: 400px;
        border: 1px solid #ccc;
        background: #f8f9fa;
      }
      .error-log {
        margin: 10px 0;
        padding: 10px;
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        border-radius: 4px;
        color: #721c24;
        font-family: monospace;
        font-size: 12px;
      }
      .success-log {
        margin: 10px 0;
        padding: 10px;
        background: #d4edda;
        border: 1px solid #c3e6cb;
        border-radius: 4px;
        color: #155724;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1>Simple Workflow Builder Test</h1>
      <p>This page tests if the workflow builder loads without any errors.</p>

      <div id="error-log"></div>

      <div id="drawflow"></div>

      <div class="mt-3">
        <button class="btn btn-primary" onclick="testAddNode()">Test Add Node</button>
        <button class="btn btn-secondary" onclick="clearErrors()">Clear Log</button>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.js"></script>

    <script>
      const errorLog = document.getElementById('error-log');

      function logError(message, isError = true) {
        const div = document.createElement('div');
        div.className = isError ? 'error-log' : 'success-log';
        div.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
        errorLog.appendChild(div);
        if (isError) {
          console.error(message);
        } else {
          console.log(message);
        }
      }

      function clearErrors() {
        errorLog.innerHTML = '';
      }

      // Catch all errors
      window.addEventListener('error', function (e) {
        logError(`Global Error: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`, true);
      });

      window.addEventListener('unhandledrejection', function (e) {
        logError(`Unhandled Promise Rejection: ${e.reason}`, true);
      });

      // Test Drawflow initialization
      let editor = null;

      try {
        logError('Starting Drawflow initialization...', false);

        if (typeof Drawflow === 'undefined') {
          logError('ERROR: Drawflow not loaded!', true);
        } else {
          logError('✓ Drawflow library loaded', false);
        }

        const container = document.getElementById('drawflow');
        if (!container) {
          logError('ERROR: Container not found!', true);
        } else {
          logError('✓ Container found', false);
        }

        editor = new Drawflow(container);
        logError('✓ Drawflow instance created', false);

        editor.start();
        logError('✓ Drawflow started successfully', false);
      } catch (error) {
        logError(`CRITICAL ERROR in initialization: ${error.message}`, true);
        logError(`Stack: ${error.stack}`, true);
      }

      function testAddNode() {
        try {
          if (!editor) {
            logError('ERROR: Editor not initialized!', true);
            return;
          }

          const html = '<div class="title">Test Node</div>';
          const nodeId = editor.addNode('test', 1, 1, 150, 150, 'test-class', {}, html);
          logError(`✓ Node added successfully with ID: ${nodeId}`, false);
        } catch (error) {
          logError(`ERROR adding node: ${error.message}`, true);
          logError(`Stack: ${error.stack}`, true);
        }
      }

      // Load test
      window.addEventListener('DOMContentLoaded', function () {
        logError('DOM Content Loaded', false);
      });

      window.addEventListener('load', function () {
        logError('Window fully loaded', false);
      });
    </script>
  </body>
</html>
