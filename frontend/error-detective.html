<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîç Error Detective - AI Conflict Dashboard</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: 'Consolas', 'Monaco', monospace;
        background: #1a1a1a;
        color: #e0e0e0;
      }
      .error-panel {
        background: #2d2d2d;
        border: 1px solid #444;
        border-radius: 8px;
        margin: 10px 0;
        padding: 15px;
      }
      .error {
        background: #3d1f1f;
        border-left: 4px solid #ff4444;
      }
      .warning {
        background: #3d351f;
        border-left: 4px solid #ffaa00;
      }
      .info {
        background: #1f2d3d;
        border-left: 4px solid #4444ff;
      }
      .success {
        background: #1f3d1f;
        border-left: 4px solid #44ff44;
      }
      .timestamp {
        color: #888;
        font-size: 0.85em;
      }
      .error-count {
        font-size: 1.5em;
        font-weight: bold;
      }
      .test-button {
        margin: 5px;
      }
      .iframe-container {
        border: 2px solid #666;
        border-radius: 8px;
        margin: 20px 0;
        background: white;
      }
      .code-block {
        background: #1a1a1a;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .error-details {
        font-size: 0.9em;
        margin-top: 10px;
      }
      pre {
        margin: 0;
        color: #e0e0e0;
      }
      .active-test {
        animation: pulse 2s infinite;
      }
      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.6;
        }
        100% {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1>üîç Error Detective</h1>
      <p class="text-info">
        This page captures ALL JavaScript errors, console messages, and network failures to help
        debug the Ollama TypeError and Workflow Builder issues.
      </p>

      <!-- Error Summary -->
      <div class="row mt-4">
        <div class="col-md-3">
          <div class="error-panel text-center">
            <div class="error-count text-danger" id="errorCount">0</div>
            <div>JavaScript Errors</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="error-panel text-center">
            <div class="error-count text-warning" id="warningCount">0</div>
            <div>Console Warnings</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="error-panel text-center">
            <div class="error-count text-info" id="consoleCount">0</div>
            <div>Console Messages</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="error-panel text-center">
            <div class="error-count text-danger" id="networkCount">0</div>
            <div>Network Failures</div>
          </div>
        </div>
      </div>

      <!-- Test Controls -->
      <div class="error-panel mt-4">
        <h3>üß™ Test Controls</h3>
        <button class="btn btn-primary test-button" onclick="testOllama()">
          Test Ollama Integration
        </button>
        <button class="btn btn-primary test-button" onclick="testWorkflowBuilder()">
          Test Workflow Builder
        </button>
        <button class="btn btn-warning test-button" onclick="clearLogs()">Clear Logs</button>
        <button class="btn btn-success test-button" onclick="exportLogs()">Export Logs</button>
        <div id="testStatus" class="mt-2"></div>
      </div>

      <!-- Error Log -->
      <div class="error-panel mt-4">
        <h3>üìã Error Log</h3>
        <div id="errorLog"></div>
      </div>

      <!-- Test Frame -->
      <div class="error-panel mt-4">
        <h3>üñºÔ∏è Test Frame</h3>
        <div id="frameContainer"></div>
      </div>
    </div>

    <script>
      // Global error tracking
      const errors = {
        jsErrors: [],
        consoleMessages: [],
        networkFailures: [],
        typeErrors: [], // Special tracking for TypeErrors
      };

      // Update counters
      function updateCounters() {
        document.getElementById('errorCount').textContent = errors.jsErrors.length;
        document.getElementById('warningCount').textContent = errors.consoleMessages.filter(
          (m) => m.type === 'warn'
        ).length;
        document.getElementById('consoleCount').textContent = errors.consoleMessages.length;
        document.getElementById('networkCount').textContent = errors.networkFailures.length;
      }

      // Log entry to UI
      function logEntry(message, type = 'info', details = null) {
        const timestamp = new Date().toLocaleTimeString();
        const logDiv = document.getElementById('errorLog');

        const entry = document.createElement('div');
        entry.className = `error-panel ${type}`;

        let html = `<div class="timestamp">${timestamp}</div><div>${escapeHtml(message)}</div>`;

        if (details) {
          html += `<div class="error-details"><pre>${escapeHtml(JSON.stringify(details, null, 2))}</pre></div>`;
        }

        entry.innerHTML = html;
        logDiv.insertBefore(entry, logDiv.firstChild);

        updateCounters();
      }

      // Escape HTML
      function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      }

      // Global error handler
      window.addEventListener('error', function (event) {
        const error = {
          message: event.message,
          source: event.filename,
          line: event.lineno,
          column: event.colno,
          error: event.error ? event.error.toString() : 'No error object',
          stack: event.error ? event.error.stack : 'No stack trace',
          timestamp: new Date().toISOString(),
        };

        errors.jsErrors.push(error);

        // Special handling for TypeErrors
        if (
          event.message.toLowerCase().includes('typeerror') ||
          (event.error && event.error.name === 'TypeError')
        ) {
          errors.typeErrors.push(error);
          logEntry(`üéØ TYPEERROR DETECTED: ${event.message}`, 'error', {
            file: `${event.filename}:${event.lineno}:${event.colno}`,
            stack: event.error ? event.error.stack : 'No stack',
          });
        } else {
          logEntry(`‚ùå JavaScript Error: ${event.message}`, 'error', error);
        }
      });

      // Console interceptor
      const originalConsole = {
        log: console.log,
        error: console.error,
        warn: console.warn,
        info: console.info,
      };

      ['log', 'error', 'warn', 'info'].forEach((method) => {
        console[method] = function (...args) {
          const message = args
            .map((arg) => (typeof arg === 'object' ? JSON.stringify(arg) : String(arg)))
            .join(' ');

          const entry = {
            type: method,
            message: message,
            timestamp: new Date().toISOString(),
          };

          errors.consoleMessages.push(entry);

          if (method === 'error') {
            logEntry(`Console Error: ${message}`, 'error');
          } else if (method === 'warn') {
            logEntry(`Console Warning: ${message}`, 'warning');
          } else {
            logEntry(`Console ${method}: ${message}`, 'info');
          }

          // Call original console method
          originalConsole[method].apply(console, args);
        };
      });

      // Network failure detection
      const originalFetch = window.fetch;
      window.fetch = async function (...args) {
        const url = args[0];
        const startTime = Date.now();

        try {
          const response = await originalFetch.apply(this, args);

          if (!response.ok) {
            const failure = {
              url: url,
              status: response.status,
              statusText: response.statusText,
              duration: Date.now() - startTime,
              timestamp: new Date().toISOString(),
            };
            errors.networkFailures.push(failure);
            logEntry(`üåê Network Failure: ${url} (${response.status})`, 'error', failure);
          }

          return response;
        } catch (error) {
          const failure = {
            url: url,
            error: error.message,
            duration: Date.now() - startTime,
            timestamp: new Date().toISOString(),
          };
          errors.networkFailures.push(failure);
          logEntry(`üåê Network Error: ${url} - ${error.message}`, 'error', failure);
          throw error;
        }
      };

      // Test Ollama Integration
      async function testOllama() {
        logEntry('üß™ Starting Ollama Integration Test...', 'info');
        document.getElementById('testStatus').innerHTML =
          '<div class="active-test">Testing Ollama...</div>';

        const container = document.getElementById('frameContainer');
        container.innerHTML = `
                <div class="iframe-container">
                    <iframe id="testFrame" src="/" width="100%" height="600" 
                            onload="monitorIframe(this, 'Ollama Test')"></iframe>
                </div>
            `;

        // Wait for frame to load, then try to trigger Ollama
        setTimeout(async () => {
          try {
            const frame = document.getElementById('testFrame');
            const frameWindow = frame.contentWindow;
            const frameDocument = frame.contentDocument;

            // Check if Ollama elements exist
            const statusBadge = frameDocument.getElementById('ollamaStatusBadge');
            const modelSelect = frameDocument.getElementById('ollamaModelDisplay');

            logEntry(
              `Ollama Status Badge Found: ${!!statusBadge}`,
              statusBadge ? 'success' : 'error'
            );
            logEntry(
              `Ollama Model Select Found: ${!!modelSelect}`,
              modelSelect ? 'success' : 'error'
            );

            if (statusBadge) {
              logEntry(`Ollama Status Text: "${statusBadge.textContent}"`, 'info');
            }

            // Try to call loadOllamaModels if it exists
            if (frameWindow.loadOllamaModels) {
              logEntry('Calling loadOllamaModels()...', 'info');
              await frameWindow.loadOllamaModels();
            } else {
              logEntry('loadOllamaModels function not found in window', 'warning');
            }

            // Look for any error messages on the page
            const errorElements = frameDocument.querySelectorAll(
              '.error, .alert-danger, [class*="error"]'
            );
            errorElements.forEach((el) => {
              if (el.textContent.trim()) {
                logEntry(`Found error element: "${el.textContent.trim()}"`, 'error');
              }
            });
          } catch (error) {
            logEntry(`Error accessing frame: ${error.message}`, 'error');
          }

          document.getElementById('testStatus').innerHTML =
            '<div class="text-success">Ollama test complete - check logs above</div>';
        }, 3000);
      }

      // Test Workflow Builder
      function testWorkflowBuilder() {
        logEntry('üß™ Starting Workflow Builder Test...', 'info');
        document.getElementById('testStatus').innerHTML =
          '<div class="active-test">Testing Workflow Builder...</div>';

        const container = document.getElementById('frameContainer');
        container.innerHTML = `
                <div class="iframe-container">
                    <iframe id="testFrame" src="/workflow-builder.html" width="100%" height="600" 
                            onload="monitorIframe(this, 'Workflow Builder Test')"></iframe>
                </div>
            `;

        setTimeout(() => {
          try {
            const frame = document.getElementById('testFrame');
            const frameWindow = frame.contentWindow;
            const frameDocument = frame.contentDocument;

            // Check page content
            const bodyText = frameDocument.body.textContent;
            const hasContent = bodyText.length > 100;
            const hasError = bodyText.toLowerCase().includes('error');

            logEntry(
              `Page has content: ${hasContent} (${bodyText.length} chars)`,
              hasContent ? 'success' : 'error'
            );
            logEntry(`Page contains error text: ${hasError}`, hasError ? 'error' : 'info');

            // Check for Drawflow
            const drawflowExists = !!frameWindow.Drawflow;
            const drawflowContainer = frameDocument.getElementById('drawflow');

            logEntry(
              `Drawflow library loaded: ${drawflowExists}`,
              drawflowExists ? 'success' : 'error'
            );
            logEntry(
              `Drawflow container exists: ${!!drawflowContainer}`,
              drawflowContainer ? 'success' : 'error'
            );

            // Check for WorkflowBuilder
            const workflowBuilderExists = !!frameWindow.workflowBuilder;
            logEntry(
              `WorkflowBuilder object exists: ${workflowBuilderExists}`,
              workflowBuilderExists ? 'success' : 'error'
            );

            if (!hasContent || hasError) {
              logEntry(`Page content preview: "${bodyText.substring(0, 200)}..."`, 'warning');
            }
          } catch (error) {
            logEntry(`Error accessing frame: ${error.message}`, 'error');
          }

          document.getElementById('testStatus').innerHTML =
            '<div class="text-success">Workflow test complete - check logs above</div>';
        }, 3000);
      }

      // Monitor iframe for errors
      function monitorIframe(iframe, testName) {
        logEntry(`üìç ${testName} - Frame loaded: ${iframe.src}`, 'info');

        try {
          const frameWindow = iframe.contentWindow;

          // Inject error monitoring into the iframe
          frameWindow.addEventListener('error', function (event) {
            logEntry(
              `üéØ [${testName}] Frame Error: ${event.message} at ${event.filename}:${event.lineno}`,
              'error',
              {
                source: event.filename,
                line: event.lineno,
                column: event.colno,
              }
            );
          });
        } catch (error) {
          logEntry(`Could not attach error listener to frame: ${error.message}`, 'warning');
        }
      }

      // Clear logs
      function clearLogs() {
        errors.jsErrors = [];
        errors.consoleMessages = [];
        errors.networkFailures = [];
        errors.typeErrors = [];
        document.getElementById('errorLog').innerHTML = '';
        updateCounters();
        logEntry('Logs cleared', 'info');
      }

      // Export logs
      function exportLogs() {
        const exportData = {
          timestamp: new Date().toISOString(),
          errors: errors,
          summary: {
            totalJsErrors: errors.jsErrors.length,
            totalTypeErrors: errors.typeErrors.length,
            totalConsoleMessages: errors.consoleMessages.length,
            totalNetworkFailures: errors.networkFailures.length,
          },
        };

        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `error-detective-${Date.now()}.json`;
        a.click();

        logEntry('Logs exported', 'success');
      }

      // Initial message
      logEntry('üîç Error Detective loaded and monitoring for errors', 'success');
      logEntry(
        'Click "Test Ollama Integration" or "Test Workflow Builder" to reproduce the errors',
        'info'
      );
    </script>
  </body>
</html>
