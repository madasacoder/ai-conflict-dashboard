<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workflow Builder Test Suite</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
      }

      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #ddd;
        border-radius: 8px;
      }

      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }

      .test-result.pass {
        background: #d4edda;
        color: #155724;
      }

      .test-result.fail {
        background: #f8d7da;
        color: #721c24;
      }

      .test-result.info {
        background: #d1ecf1;
        color: #0c5460;
      }

      .error-details {
        margin-top: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        white-space: pre-wrap;
      }

      button {
        margin: 5px;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }

      button:hover {
        background: #0056b3;
      }

      .status-indicator {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 10px;
      }

      .status-indicator.green {
        background: #28a745;
      }
      .status-indicator.red {
        background: #dc3545;
      }
      .status-indicator.yellow {
        background: #ffc107;
      }
    </style>
  </head>
  <body>
    <h1>Workflow Builder Test Suite</h1>

    <div class="test-section">
      <h2>1. CDN Dependencies Test</h2>
      <button onclick="testCDNDependencies()">Run CDN Tests</button>
      <div id="cdn-results"></div>
    </div>

    <div class="test-section">
      <h2>2. JavaScript Errors Test</h2>
      <button onclick="testJavaScriptErrors()">Check for JS Errors</button>
      <div id="js-results"></div>
    </div>

    <div class="test-section">
      <h2>3. API Connectivity Test</h2>
      <button onclick="testAPIConnectivity()">Test API Connection</button>
      <div id="api-results"></div>
    </div>

    <div class="test-section">
      <h2>4. Browser Compatibility Test</h2>
      <button onclick="testBrowserCompatibility()">Check Browser Support</button>
      <div id="browser-results"></div>
    </div>

    <div class="test-section">
      <h2>5. Workflow Builder Components Test</h2>
      <button onclick="testWorkflowComponents()">Test Components</button>
      <div id="component-results"></div>
    </div>

    <div class="test-section">
      <h2>6. Live Error Console</h2>
      <div
        id="error-console"
        style="
          background: #f8f9fa;
          padding: 20px;
          border-radius: 4px;
          font-family: monospace;
          font-size: 12px;
          max-height: 300px;
          overflow-y: auto;
        "
      >
        <p>Monitoring for errors...</p>
      </div>
    </div>

    <script>
      // Error monitoring
      const errorConsole = document.getElementById('error-console');
      let errorCount = 0;

      window.addEventListener('error', (event) => {
        errorCount++;
        const errorDiv = document.createElement('div');
        errorDiv.className = 'test-result fail';
        errorDiv.innerHTML = `
                <strong>Error #${errorCount}:</strong> ${event.message}
                <div class="error-details">
                    File: ${event.filename}
                    Line: ${event.lineno}, Column: ${event.colno}
                    ${event.error ? 'Stack: ' + event.error.stack : ''}
                </div>
            `;
        errorConsole.appendChild(errorDiv);
      });

      // Test functions
      async function testCDNDependencies() {
        const results = document.getElementById('cdn-results');
        results.innerHTML = '';

        const dependencies = [
          {
            name: 'Bootstrap CSS',
            url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css',
            type: 'css',
          },
          {
            name: 'Bootstrap JS',
            url: 'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js',
            type: 'script',
          },
          {
            name: 'Bootstrap Icons',
            url: 'https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css',
            type: 'css',
          },
          {
            name: 'DOMPurify',
            url: 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js',
            type: 'script',
          },
          {
            name: 'Drawflow CSS',
            url: 'https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.css',
            type: 'css',
          },
          {
            name: 'Drawflow JS',
            url: 'https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.js',
            type: 'script',
          },
        ];

        for (const dep of dependencies) {
          try {
            const response = await fetch(dep.url);
            const status = response.ok ? 'pass' : 'fail';

            results.innerHTML += `
                        <div class="test-result ${status}">
                            <span class="status-indicator ${response.ok ? 'green' : 'red'}"></span>
                            <strong>${dep.name}:</strong> ${response.ok ? 'Loaded successfully' : `Failed (${response.status})`}
                            <br>URL: ${dep.url}
                        </div>
                    `;
          } catch (error) {
            results.innerHTML += `
                        <div class="test-result fail">
                            <span class="status-indicator red"></span>
                            <strong>${dep.name}:</strong> Network error
                            <div class="error-details">${error.message}</div>
                        </div>
                    `;
          }
        }
      }

      function testJavaScriptErrors() {
        const results = document.getElementById('js-results');
        results.innerHTML = '';

        // Test if key functions exist
        const tests = [
          { name: 'DOMPurify', exists: typeof DOMPurify !== 'undefined' },
          { name: 'Bootstrap', exists: typeof bootstrap !== 'undefined' },
          { name: 'Drawflow', exists: typeof Drawflow !== 'undefined' },
          { name: 'localStorage', exists: typeof localStorage !== 'undefined' },
          { name: 'fetch API', exists: typeof fetch !== 'undefined' },
        ];

        tests.forEach((test) => {
          results.innerHTML += `
                    <div class="test-result ${test.exists ? 'pass' : 'fail'}">
                        <span class="status-indicator ${test.exists ? 'green' : 'red'}"></span>
                        <strong>${test.name}:</strong> ${test.exists ? 'Available' : 'Not found'}
                    </div>
                `;
        });

        // Test localStorage
        try {
          localStorage.setItem('test', 'value');
          localStorage.removeItem('test');
          results.innerHTML += `
                    <div class="test-result pass">
                        <span class="status-indicator green"></span>
                        <strong>localStorage:</strong> Working properly
                    </div>
                `;
        } catch (e) {
          results.innerHTML += `
                    <div class="test-result fail">
                        <span class="status-indicator red"></span>
                        <strong>localStorage:</strong> Error - ${e.message}
                    </div>
                `;
        }
      }

      async function testAPIConnectivity() {
        const results = document.getElementById('api-results');
        results.innerHTML = '';

        // Test backend API
        try {
          const response = await fetch('http://localhost:8000/docs');
          results.innerHTML += `
                    <div class="test-result ${response.ok ? 'pass' : 'fail'}">
                        <span class="status-indicator ${response.ok ? 'green' : 'red'}"></span>
                        <strong>Backend API:</strong> ${response.ok ? 'Connected' : `Error (${response.status})`}
                    </div>
                `;
        } catch (error) {
          results.innerHTML += `
                    <div class="test-result fail">
                        <span class="status-indicator red"></span>
                        <strong>Backend API:</strong> Not reachable
                        <div class="error-details">${error.message}</div>
                    </div>
                `;
        }

        // Test workflow endpoint
        try {
          const response = await fetch('/api/workflows/execute', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ workflow: { nodes: [], edges: [] }, api_keys: {} }),
          });

          results.innerHTML += `
                    <div class="test-result ${response.ok || response.status === 400 ? 'pass' : 'fail'}">
                        <span class="status-indicator ${response.ok || response.status === 400 ? 'green' : 'red'}"></span>
                        <strong>Workflow Endpoint:</strong> ${response.ok || response.status === 400 ? 'Accessible' : `Error (${response.status})`}
                    </div>
                `;
        } catch (error) {
          results.innerHTML += `
                    <div class="test-result fail">
                        <span class="status-indicator red"></span>
                        <strong>Workflow Endpoint:</strong> Not reachable
                        <div class="error-details">${error.message}</div>
                    </div>
                `;
        }
      }

      function testBrowserCompatibility() {
        const results = document.getElementById('browser-results');
        results.innerHTML = '';

        const features = [
          {
            name: 'ES6 Support',
            test: () => {
              const a = () => {};
              return true;
            },
          },
          { name: 'CSS Grid', test: () => CSS.supports('display', 'grid') },
          { name: 'Flexbox', test: () => CSS.supports('display', 'flex') },
          {
            name: 'SVG Support',
            test: () =>
              document.implementation.hasFeature(
                'http://www.w3.org/TR/SVG11/feature#BasicStructure',
                '1.1'
              ),
          },
          { name: 'Drag & Drop API', test: () => 'draggable' in document.createElement('div') },
          { name: 'JSON Support', test: () => window.JSON && typeof JSON.parse === 'function' },
        ];

        features.forEach((feature) => {
          let supported = false;
          try {
            supported = feature.test();
          } catch (e) {
            supported = false;
          }

          results.innerHTML += `
                    <div class="test-result ${supported ? 'pass' : 'fail'}">
                        <span class="status-indicator ${supported ? 'green' : 'red'}"></span>
                        <strong>${feature.name}:</strong> ${supported ? 'Supported' : 'Not supported'}
                    </div>
                `;
        });

        // Browser info
        results.innerHTML += `
                <div class="test-result info">
                    <strong>Browser:</strong> ${navigator.userAgent}
                </div>
            `;
      }

      async function testWorkflowComponents() {
        const results = document.getElementById('component-results');
        results.innerHTML = '';

        // Test loading workflow builder page
        try {
          const response = await fetch('/workflow-builder.html');
          const html = await response.text();

          // Check for key elements
          const checks = [
            { name: 'Drawflow container', exists: html.includes('id="drawflow"') },
            { name: 'Node palette', exists: html.includes('node-palette') },
            { name: 'Workflow JS', exists: html.includes('workflow-builder.js') },
            { name: 'Bootstrap loaded', exists: html.includes('bootstrap') },
            { name: 'DOMPurify loaded', exists: html.includes('purify.min.js') },
          ];

          checks.forEach((check) => {
            results.innerHTML += `
                        <div class="test-result ${check.exists ? 'pass' : 'fail'}">
                            <span class="status-indicator ${check.exists ? 'green' : 'red'}"></span>
                            <strong>${check.name}:</strong> ${check.exists ? 'Found' : 'Missing'}
                        </div>
                    `;
          });

          // Test if JS file exists
          const jsResponse = await fetch('/js/workflow-builder.js');
          results.innerHTML += `
                    <div class="test-result ${jsResponse.ok ? 'pass' : 'fail'}">
                        <span class="status-indicator ${jsResponse.ok ? 'green' : 'red'}"></span>
                        <strong>JavaScript file:</strong> ${jsResponse.ok ? 'Found' : 'Missing (404)'}
                    </div>
                `;
        } catch (error) {
          results.innerHTML += `
                    <div class="test-result fail">
                        <span class="status-indicator red"></span>
                        <strong>Page Load:</strong> Failed
                        <div class="error-details">${error.message}</div>
                    </div>
                `;
        }
      }

      // Run all tests on load
      window.addEventListener('load', () => {
        console.log('Test suite loaded. Click buttons to run individual tests.');
      });
    </script>
  </body>
</html>
