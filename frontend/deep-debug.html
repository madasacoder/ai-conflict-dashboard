<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deep Debug - What's Really Happening</title>
    <style>
      body {
        font-family: monospace;
        padding: 20px;
        background: #1a1a1a;
        color: #00ff00;
      }
      .error {
        color: #ff4444;
      }
      .warn {
        color: #ffaa00;
      }
      .info {
        color: #4444ff;
      }
      .success {
        color: #00ff00;
      }
      .debug-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #333;
      }
      pre {
        background: #000;
        padding: 10px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <h1>üîç Deep Debug Analysis</h1>
    <div id="output"></div>

    <script>
      const output = document.getElementById('output');

      function log(message, type = 'info') {
        const div = document.createElement('div');
        div.className = type;
        div.innerHTML = DOMPurify.sanitize(`[${new Date().toISOString()}] ${message}`);
        output.appendChild(div);
        console.log(message);
      }

      function addSection(title) {
        const section = document.createElement('div');
        section.className = 'debug-section';
        section.innerHTML = DOMPurify.sanitize(`<h3>${title}</h3>`);
        output.appendChild(section);
        return section;
      }

      // 1. Check what's actually happening with Ollama
      async function debugOllama() {
        const section = addSection('üî¨ Ollama Deep Debug');

        log('=== OLLAMA DEBUGGING ===', 'info');

        // Check if we're on main page or workflow page
        const isMainPage =
          window.location.pathname === '/' || window.location.pathname === '/index.html';
        const isWorkflowPage = window.location.pathname.includes('workflow-builder');

        log(`Page type: ${isMainPage ? 'MAIN' : isWorkflowPage ? 'WORKFLOW' : 'OTHER'}`, 'info');

        if (isMainPage) {
          // Check DOM elements
          const statusBadge = document.getElementById('ollamaStatusBadge');
          const modelSelect = document.getElementById('ollamaModelDisplay');

          log(
            `Status badge element: ${statusBadge ? 'EXISTS' : 'MISSING'}`,
            statusBadge ? 'success' : 'error'
          );
          log(
            `Model select element: ${modelSelect ? 'EXISTS' : 'MISSING'}`,
            modelSelect ? 'success' : 'error'
          );

          if (statusBadge) {
            log(`Current status text: "${statusBadge.textContent}"`, 'info');
            log(`Current status class: "${statusBadge.className}"`, 'info');
            log(`Current status title: "${statusBadge.title}"`, 'info');
          }

          // Check if loadOllamaModels function exists
          if (typeof window.loadOllamaModels === 'function') {
            log('loadOllamaModels function EXISTS', 'success');

            // Try to call it and catch any errors
            try {
              log('Attempting to call loadOllamaModels...', 'info');
              await window.loadOllamaModels();
              log('loadOllamaModels completed without throwing', 'success');
            } catch (error) {
              log(`loadOllamaModels ERROR: ${error.message}`, 'error');
              log(`Stack: ${error.stack}`, 'error');
            }
          } else {
            log('loadOllamaModels function MISSING', 'error');
          }

          // Test the API directly
          try {
            log('Testing Ollama API directly...', 'info');
            const response = await fetch('http://localhost:8000/api/ollama/models');
            log(`API Response status: ${response.status}`, response.ok ? 'success' : 'error');

            const data = await response.json();
            log(`API Response data: ${JSON.stringify(data, null, 2)}`, 'info');
          } catch (error) {
            log(`API Direct test ERROR: ${error.message}`, 'error');
          }
        } else {
          log('Not on main page - Ollama elements not expected', 'info');
        }
      }

      // 2. Check what's happening with Workflow Builder
      async function debugWorkflowBuilder() {
        const section = addSection('üõ†Ô∏è Workflow Builder Deep Debug');

        log('=== WORKFLOW BUILDER DEBUGGING ===', 'info');

        const isWorkflowPage = window.location.pathname.includes('workflow-builder');
        log(`On workflow page: ${isWorkflowPage}`, 'info');

        if (isWorkflowPage) {
          // Check if Drawflow loaded
          log(
            `Drawflow available: ${typeof Drawflow !== 'undefined'}`,
            typeof Drawflow !== 'undefined' ? 'success' : 'error'
          );

          // Check DOM elements
          const drawflowDiv = document.getElementById('drawflow');
          log(
            `Drawflow container: ${drawflowDiv ? 'EXISTS' : 'MISSING'}`,
            drawflowDiv ? 'success' : 'error'
          );

          // Check WorkflowBuilder
          log(
            `WorkflowBuilder available: ${typeof window.workflowBuilder !== 'undefined'}`,
            typeof window.workflowBuilder !== 'undefined' ? 'success' : 'error'
          );

          if (typeof window.workflowBuilder !== 'undefined') {
            log(
              `WorkflowBuilder.editor: ${window.workflowBuilder.editor ? 'INITIALIZED' : 'NULL'}`,
              window.workflowBuilder.editor ? 'success' : 'error'
            );
          }

          // Try to create a simple Drawflow instance
          if (typeof Drawflow !== 'undefined' && drawflowDiv) {
            try {
              log('Attempting to create test Drawflow instance...', 'info');
              const testEditor = new Drawflow(drawflowDiv);
              testEditor.start();
              log('Test Drawflow instance created successfully', 'success');

              // Try to add a test node
              const nodeId = testEditor.addNode(
                'test',
                0,
                1,
                100,
                100,
                'test',
                {},
                '<div>Test</div>'
              );
              log(`Test node added with ID: ${nodeId}`, 'success');
            } catch (error) {
              log(`Drawflow test ERROR: ${error.message}`, 'error');
              log(`Stack: ${error.stack}`, 'error');
            }
          }
        }
      }

      // 3. Check all loaded scripts
      function debugScripts() {
        const section = addSection('üìú Script Loading Debug');

        log('=== SCRIPT LOADING DEBUG ===', 'info');

        const scripts = document.querySelectorAll('script[src]');
        log(`Found ${scripts.length} external scripts:`, 'info');

        scripts.forEach((script, i) => {
          log(`${i + 1}. ${script.src}`, 'info');

          // Check if script loaded successfully
          if (script.complete === false) {
            log(`   ‚ùå Script still loading or failed`, 'error');
          } else {
            log(`   ‚úÖ Script loaded`, 'success');
          }
        });

        // Check for any failed resources
        performance.getEntriesByType('resource').forEach((resource) => {
          if (resource.name.includes('.js') || resource.name.includes('.css')) {
            if (resource.transferSize === 0 && resource.encodedBodySize === 0) {
              log(`‚ùå Failed to load: ${resource.name}`, 'error');
            }
          }
        });
      }

      // 4. Capture all console messages
      function debugConsole() {
        const section = addSection('üí¨ Console Messages');

        log('=== CONSOLE MESSAGE CAPTURE ===', 'info');

        // Override console methods to capture everything
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;

        console.log = function (...args) {
          log(`CONSOLE.LOG: ${args.join(' ')}`, 'info');
          originalLog.apply(console, args);
        };

        console.error = function (...args) {
          log(`CONSOLE.ERROR: ${args.join(' ')}`, 'error');
          originalError.apply(console, args);
        };

        console.warn = function (...args) {
          log(`CONSOLE.WARN: ${args.join(' ')}`, 'warn');
          originalWarn.apply(console, args);
        };
      }

      // Global error capture
      window.addEventListener('error', function (e) {
        log(`GLOBAL ERROR: ${e.message}`, 'error');
        log(`  File: ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        log(`  Stack: ${e.error?.stack || 'No stack'}`, 'error');
      });

      window.addEventListener('unhandledrejection', function (e) {
        log(`UNHANDLED PROMISE REJECTION: ${e.reason}`, 'error');
      });

      // Run all debugging
      async function runAllDebugging() {
        log('üöÄ Starting deep debugging...', 'info');

        debugConsole();
        debugScripts();

        // Wait a bit for scripts to load
        setTimeout(async () => {
          await debugOllama();
          await debugWorkflowBuilder();

          log('üèÅ Deep debugging complete!', 'success');
        }, 2000);
      }

      // Start debugging when page loads
      window.addEventListener('DOMContentLoaded', runAllDebugging);
    </script>
  </body>
</html>
