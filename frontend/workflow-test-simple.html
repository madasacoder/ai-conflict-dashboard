<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workflow Builder Simple Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .status {
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        color: #155724;
      }
      .error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .info {
        background-color: #d1ecf1;
        color: #0c5460;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1>Workflow Builder Test</h1>
      <p>This page tests the workflow builder functionality step by step.</p>

      <div id="status"></div>

      <div class="mt-3">
        <a href="workflow-builder.html" class="btn btn-primary">Go to Workflow Builder</a>
        <button class="btn btn-secondary" onclick="testAPI()">Test Backend API</button>
      </div>

      <div class="mt-4">
        <h3>Test Results:</h3>
        <div id="results"></div>
      </div>
    </div>

    <script>
      function addStatus(message, type = 'info') {
        const statusDiv = document.getElementById('status');
        const div = document.createElement('div');
        div.className = `status ${type}`;
        div.textContent = message;
        statusDiv.appendChild(div);
      }

      function addResult(test, passed, details = '') {
        const resultsDiv = document.getElementById('results');
        const div = document.createElement('div');
        div.className = passed ? 'text-success' : 'text-danger';
        div.innerHTML = DOMPurify.sanitize(
          `${passed ? '✓' : '✗'} ${test}${details ? ': ' + details : ''}`
        );
        resultsDiv.appendChild(div);
      }

      // Test 1: Check if workflow builder page exists
      fetch('workflow-builder.html')
        .then((response) => {
          addResult('Workflow builder page exists', response.ok);
          if (!response.ok) {
            addStatus('Workflow builder page not found!', 'error');
          }
        })
        .catch((error) => {
          addResult('Workflow builder page exists', false, error.message);
        });

      // Test 2: Check if JavaScript file exists
      fetch('js/workflow-builder-fixed.js')
        .then((response) => {
          addResult('JavaScript file exists', response.ok);
          if (!response.ok) {
            addStatus('JavaScript file not found!', 'error');
          }
        })
        .catch((error) => {
          addResult('JavaScript file exists', false, error.message);
        });

      // Test 3: Check localStorage for saved workflow
      const savedWorkflow = localStorage.getItem('aicd_workflow');
      if (savedWorkflow) {
        try {
          const data = JSON.parse(savedWorkflow);
          addResult('Saved workflow in localStorage', true, 'Found workflow data');
          addStatus('Found saved workflow in localStorage', 'info');
        } catch (e) {
          addResult('Saved workflow in localStorage', false, 'Invalid JSON');
        }
      } else {
        addResult('Saved workflow in localStorage', false, 'No saved workflow');
      }

      // Test 4: Check theme in localStorage
      const theme = localStorage.getItem('theme');
      addResult('Theme preference', true, theme || 'default');

      // Test 5: Check API keys
      const apiKeys = ['openai_api_key', 'claude_api_key', 'gemini_api_key', 'grok_api_key'];
      let hasAnyKey = false;
      apiKeys.forEach((key) => {
        if (localStorage.getItem(key)) {
          hasAnyKey = true;
        }
      });
      addResult(
        'API keys configured',
        hasAnyKey,
        hasAnyKey ? 'At least one key found' : 'No API keys configured'
      );

      if (!hasAnyKey) {
        addStatus('No API keys found. Workflow execution will require API keys.', 'info');
      }

      // Test backend API
      async function testAPI() {
        addStatus('Testing backend API...', 'info');

        try {
          const response = await fetch('http://localhost:8000/docs');
          if (response.ok) {
            addResult('Backend API accessible', true, 'FastAPI docs available');
            addStatus('Backend is running on port 8000', 'success');
          } else {
            addResult('Backend API accessible', false, `Status: ${response.status}`);
            addStatus('Backend returned error status', 'error');
          }
        } catch (error) {
          addResult('Backend API accessible', false, error.message);
          addStatus('Backend not running. Start with: uvicorn main:app --reload', 'error');
        }

        // Test workflow endpoint
        try {
          const response = await fetch('http://localhost:8000/api/workflows/execute', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ workflow: { nodes: [], edges: [] }, api_keys: {} }),
          });

          addResult('Workflow execute endpoint', response.ok, `Status: ${response.status}`);
        } catch (error) {
          addResult('Workflow execute endpoint', false, error.message);
        }
      }

      // Run backend test automatically
      setTimeout(testAPI, 1000);
    </script>
  </body>
</html>
