<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Workflow Builder Diagnostic</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .log-entry {
        padding: 5px;
        margin: 2px 0;
        font-family: monospace;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
      }
    </style>
  </head>
  <body>
    <div class="container mt-4">
      <h1>🔧 Workflow Builder Diagnostic</h1>
      <p>This page diagnoses why the WorkflowBuilder object doesn't exist.</p>

      <div id="diagnosticLog" class="border rounded p-3 mt-3"></div>

      <div class="mt-3">
        <button class="btn btn-primary" onclick="runFullTest()">Run Full Diagnostic</button>
        <button class="btn btn-warning" onclick="clearLog()">Clear Log</button>
      </div>
    </div>

    <script>
      function log(message, type = 'info') {
        const logDiv = document.getElementById('diagnosticLog');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        logDiv.appendChild(entry);
      }

      function clearLog() {
        document.getElementById('diagnosticLog').innerHTML = '';
      }

      // Immediate checks (before any scripts load)
      log('🚀 Diagnostic started', 'info');
      log(`Current URL: ${window.location.href}`, 'info');
      log(`Document readyState: ${document.readyState}`, 'info');

      // Check as DOM loads
      document.addEventListener('DOMContentLoaded', () => {
        log('📄 DOM Content Loaded', 'success');
      });

      window.addEventListener('load', () => {
        log('🖼️ Window fully loaded', 'success');
      });

      // Global error handler
      window.addEventListener('error', (e) => {
        log(`❌ JavaScript Error: ${e.message} at ${e.filename}:${e.lineno}:${e.colno}`, 'error');
        if (e.error && e.error.stack) {
          log(`Stack: ${e.error.stack}`, 'error');
        }
      });

      async function runFullTest() {
        log('🧪 Starting full diagnostic...', 'info');

        // Test 1: Check if we can load the workflow builder page
        try {
          log('📥 Fetching workflow-builder.html...', 'info');
          const response = await fetch('/workflow-builder.html');
          const html = await response.text();
          log(`✅ Page loaded (${html.length} bytes)`, 'success');

          // Check what JS file is referenced
          const jsMatch = html.match(/workflow-builder[^"]*\.js/);
          if (jsMatch) {
            log(`📜 JS file referenced: ${jsMatch[0]}`, 'info');
          }

          // Test if Drawflow CDN is accessible
          log('🌐 Testing Drawflow CDN...', 'info');
          try {
            const drawflowResponse = await fetch(
              'https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.js'
            );
            if (drawflowResponse.ok) {
              log('✅ Drawflow CDN is accessible', 'success');
            } else {
              log(`❌ Drawflow CDN returned ${drawflowResponse.status}`, 'error');
            }
          } catch (e) {
            log(`❌ Cannot reach Drawflow CDN: ${e.message}`, 'error');
          }

          // Load the workflow JS file
          const jsFile = jsMatch ? jsMatch[0] : 'workflow-builder-fixed.js';
          log(`📥 Loading /js/${jsFile}...`, 'info');
          const jsResponse = await fetch(`/js/${jsFile}`);
          const jsContent = await jsResponse.text();
          log(`✅ JS file loaded (${jsContent.length} bytes)`, 'success');

          // Check for key patterns
          const hasClass = jsContent.includes('class WorkflowBuilder');
          const hasGlobalVar =
            jsContent.includes('let workflowBuilder') || jsContent.includes('var workflowBuilder');
          const hasWindowAssign = jsContent.includes('window.workflowBuilder');
          const hasDOMReady = jsContent.includes('DOMContentLoaded');
          const hasDrawflowCheck = jsContent.includes("typeof Drawflow === 'undefined'");

          log('📋 Code analysis:', 'info');
          log(
            `  - Has WorkflowBuilder class: ${hasClass ? '✅' : '❌'}`,
            hasClass ? 'success' : 'error'
          );
          log(
            `  - Has global variable declaration: ${hasGlobalVar ? '✅' : '❌'}`,
            hasGlobalVar ? 'success' : 'error'
          );
          log(
            `  - Assigns to window: ${hasWindowAssign ? '✅' : '❌'}`,
            hasWindowAssign ? 'info' : 'warning'
          );
          log(
            `  - Waits for DOM ready: ${hasDOMReady ? '✅' : '❌'}`,
            hasDOMReady ? 'success' : 'warning'
          );
          log(
            `  - Checks for Drawflow: ${hasDrawflowCheck ? '✅' : '❌'}`,
            hasDrawflowCheck ? 'success' : 'warning'
          );

          // Test loading in an iframe
          log('🖼️ Testing in iframe...', 'info');
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = '/workflow-builder.html';

          iframe.onload = () => {
            setTimeout(() => {
              try {
                const iframeWindow = iframe.contentWindow;
                log('📊 Iframe test results:', 'info');
                log(
                  `  - Drawflow loaded: ${typeof iframeWindow.Drawflow !== 'undefined' ? '✅' : '❌'}`,
                  typeof iframeWindow.Drawflow !== 'undefined' ? 'success' : 'error'
                );
                log(
                  `  - workflowBuilder exists: ${typeof iframeWindow.workflowBuilder !== 'undefined' ? '✅' : '❌'}`,
                  typeof iframeWindow.workflowBuilder !== 'undefined' ? 'success' : 'error'
                );

                // Check console for errors
                if (iframeWindow.console && iframeWindow.console.error) {
                  log('  - Check browser console for any errors in the iframe', 'warning');
                }

                // Check if initialization happened
                const drawflowDiv = iframe.contentDocument.getElementById('drawflow');
                if (drawflowDiv) {
                  const hasContent = drawflowDiv.innerHTML.trim().length > 0;
                  log(
                    `  - Drawflow container has content: ${hasContent ? '✅' : '❌'}`,
                    hasContent ? 'success' : 'warning'
                  );

                  if (drawflowDiv.innerHTML.includes('alert')) {
                    log('  - ⚠️ Found alert message in container', 'warning');
                    const alertText = drawflowDiv.textContent.trim();
                    log(`    Alert: "${alertText}"`, 'warning');
                  }
                }
              } catch (e) {
                log(`❌ Iframe test error: ${e.message}`, 'error');
              }
              document.body.removeChild(iframe);
            }, 3000); // Give it time to initialize
            // Note: This is a short-lived diagnostic timeout, cleanup not critical
          };

          iframe.onerror = () => {
            log('❌ Failed to load iframe', 'error');
          };

          document.body.appendChild(iframe);
        } catch (error) {
          log(`❌ Test failed: ${error.message}`, 'error');
        }

        log('🏁 Diagnostic complete', 'info');
      }

      // Auto-run on load
      window.addEventListener('load', () => {
        setTimeout(runFullTest, 1000);
        // Note: This is a diagnostic startup delay, cleanup not critical
      });
    </script>
  </body>
</html>
