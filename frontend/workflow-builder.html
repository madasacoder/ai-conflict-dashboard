<!doctype html>
<html lang="en">
  <head>
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests 0" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Conflict Dashboard - Workflow Builder</title>
    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Bootstrap Icons -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <!-- Drawflow CSS -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.css"
    />
    <!-- DOMPurify -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>

    <style>
      :root {
        --bg-color: #ffffff;
        --text-color: #212529;
        --card-bg: #ffffff;
        --border-color: #dee2e6;
        --node-input: #3498db;
        --node-llm: #e74c3c;
        --node-compare: #f39c12;
        --node-summarize: #9b59b6;
        --node-output: #27ae60;
      }

      [data-theme='dark'] {
        --bg-color: #212529;
        --text-color: #f8f9fa;
        --card-bg: #2c3034;
        --border-color: #495057;
      }

      body {
        background-color: var(--bg-color);
        color: var(--text-color);
        margin: 0;
        padding: 0;
        height: 100vh;
        overflow: hidden;
      }

      .workflow-container {
        display: flex;
        height: 100vh;
      }

      /* Node Palette */
      .node-palette {
        width: 280px;
        background: var(--card-bg);
        border-right: 1px solid var(--border-color);
        padding: 20px;
        overflow-y: auto;
      }

      .node-item {
        background: var(--bg-color);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        cursor: move;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .node-item:hover {
        transform: translateX(5px);
        border-color: var(--text-color);
      }

      .node-item.input {
        border-left: 4px solid var(--node-input);
      }
      .node-item.llm {
        border-left: 4px solid var(--node-llm);
      }
      .node-item.compare {
        border-left: 4px solid var(--node-compare);
      }
      .node-item.summarize {
        border-left: 4px solid var(--node-summarize);
      }
      .node-item.output {
        border-left: 4px solid var(--node-output);
      }

      .node-icon {
        font-size: 24px;
      }

      .node-info h6 {
        margin: 0;
        font-size: 14px;
      }

      .node-info small {
        color: var(--text-color);
        opacity: 0.7;
      }

      /* Main Canvas */
      .workflow-canvas {
        flex: 1;
        position: relative;
      }

      #drawflow {
        width: 100%;
        height: 100%;
        background-color: var(--bg-color);
        background-image: radial-gradient(circle, var(--border-color) 1px, transparent 1px);
        background-size: 20px 20px;
      }

      /* Toolbar */
      .workflow-toolbar {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
        background: var(--card-bg);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Custom node styles */
      .drawflow-node {
        background: var(--card-bg);
        border: 2px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        min-width: 180px;
      }

      .drawflow-node.selected {
        border-color: #0d6efd;
        box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.25);
      }

      .drawflow-node .title {
        font-weight: 600;
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .drawflow-node.input .title {
        color: var(--node-input);
      }
      .drawflow-node.llm .title {
        color: var(--node-llm);
      }
      .drawflow-node.compare .title {
        color: var(--node-compare);
      }
      .drawflow-node.summarize .title {
        color: var(--node-summarize);
      }
      .drawflow-node.output .title {
        color: var(--node-output);
      }

      /* Mode toggle */
      .mode-toggle {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 100;
      }

      /* Config Panel */
      .config-panel {
        position: absolute;
        right: 0;
        top: 0;
        width: 320px;
        height: 100%;
        background: var(--card-bg);
        border-left: 1px solid var(--border-color);
        padding: 20px;
        transform: translateX(100%);
        transition: transform 0.3s;
        overflow-y: auto;
      }

      .config-panel.open {
        transform: translateX(0);
      }

      /* Connection Visual Feedback */
      .drawflow .connection {
        stroke-width: 3px !important;
        stroke: #007bff !important;
        opacity: 0.8;
        transition: all 0.3s ease;
      }

      .drawflow .connection:hover {
        stroke-width: 5px !important;
        stroke: #0056b3 !important;
        opacity: 1;
      }

      .drawflow .connection.selected {
        stroke: #28a745 !important;
        stroke-width: 4px !important;
        opacity: 1;
      }

      /* Connection points (inputs/outputs) */
      .drawflow .input,
      .drawflow .output {
        width: 15px;
        height: 15px;
        border: 2px solid #007bff;
        background: white;
        border-radius: 50%;
        cursor: crosshair;
        transition: all 0.3s ease;
      }

      .drawflow .input:hover,
      .drawflow .output:hover {
        transform: scale(1.3);
        border-color: #0056b3;
        background: #e3f2fd;
      }

      .drawflow .output {
        background: #007bff;
      }

      .drawflow .output:hover {
        background: #0056b3;
      }

      /* Connection creation feedback */
      .drawflow .connection-creating {
        stroke: #ffc107 !important;
        stroke-width: 4px !important;
        stroke-dasharray: 5, 5;
        animation: dash 1s linear infinite;
      }

      @keyframes dash {
        to {
          stroke-dashoffset: -10;
        }
      }

      /* Node connection states */
      .drawflow-node.connection-source {
        box-shadow:
          0 0 0 2px #007bff,
          0 0 10px rgba(0, 123, 255, 0.3);
      }

      .drawflow-node.connection-target {
        box-shadow:
          0 0 0 2px #28a745,
          0 0 10px rgba(40, 167, 69, 0.3);
      }

      /* Execution States */
      .drawflow-node.execution-success {
        box-shadow: 0 0 0 3px #27ae60;
      }

      .drawflow-node.execution-error {
        box-shadow: 0 0 0 3px #e74c3c;
      }

      .node-output-preview {
        margin-top: 10px;
        padding: 8px;
        background: #f0f0f0;
        border-radius: 4px;
        font-size: 12px;
        max-height: 100px;
        overflow-y: auto;
        color: #333;
      }

      [data-theme='dark'] .node-output-preview {
        background: #495057;
        color: #f8f9fa;
      }

      /* Results Modal */
      .node-result {
        background: #f8f9fa;
      }

      [data-theme='dark'] .node-result {
        background: #2c3034;
      }

      .model-response pre {
        max-height: 300px;
        overflow-y: auto;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .node-palette {
          width: 200px;
        }

        .config-panel {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <!-- Mode Toggle -->
    <div class="mode-toggle">
      <a href="index.html" class="btn btn-outline-primary btn-sm">
        <i class="bi bi-arrow-left"></i> Classic Mode
      </a>
    </div>

    <div class="workflow-container">
      <!-- Node Palette -->
      <div class="node-palette">
        <h5 class="mb-4">Node Library</h5>

        <div class="node-category mb-3">
          <h6 class="text-muted mb-2">SOURCES</h6>
          <div class="node-item input" draggable="true" data-node-type="input">
            <div class="node-icon">ðŸ“¥</div>
            <div class="node-info">
              <h6>Text Input</h6>
              <small>Text, file, or URL</small>
            </div>
          </div>
        </div>

        <div class="node-category mb-3">
          <h6 class="text-muted mb-2">PROCESSING</h6>
          <div class="node-item llm" draggable="true" data-node-type="llm">
            <div class="node-icon">ðŸ§ </div>
            <div class="node-info">
              <h6>LLM Processor</h6>
              <small>Multi-model AI</small>
            </div>
          </div>
          <div class="node-item compare" draggable="true" data-node-type="compare">
            <div class="node-icon">ðŸ”„</div>
            <div class="node-info">
              <h6>Compare Responses</h6>
              <small>Find conflicts</small>
            </div>
          </div>
          <div class="node-item summarize" draggable="true" data-node-type="summarize">
            <div class="node-icon">ðŸ“„</div>
            <div class="node-info">
              <h6>Summarize</h6>
              <small>Consolidate results</small>
            </div>
          </div>
        </div>

        <div class="node-category">
          <h6 class="text-muted mb-2">OUTPUTS</h6>
          <div class="node-item output" draggable="true" data-node-type="output">
            <div class="node-icon">ðŸ“¤</div>
            <div class="node-info">
              <h6>Output</h6>
              <small>Export results</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Canvas -->
      <div class="workflow-canvas">
        <div id="drawflow"></div>

        <!-- Toolbar -->
        <div class="workflow-toolbar">
          <button class="btn btn-sm btn-outline-primary" onclick="workflowBuilder.zoomIn()">
            <i class="bi bi-zoom-in"></i>
          </button>
          <button class="btn btn-sm btn-outline-primary" onclick="workflowBuilder.zoomOut()">
            <i class="bi bi-zoom-out"></i>
          </button>
          <button class="btn btn-sm btn-outline-primary" onclick="workflowBuilder.zoomReset()">
            <i class="bi bi-arrows-angle-expand"></i>
          </button>
          <div class="vr"></div>
          <button class="btn btn-sm btn-outline-success" onclick="workflowBuilder.exportWorkflow()">
            <i class="bi bi-download"></i> Export
          </button>
          <button class="btn btn-sm btn-outline-primary" onclick="workflowBuilder.importWorkflow()">
            <i class="bi bi-upload"></i> Import
          </button>
          <button class="btn btn-sm btn-primary" onclick="workflowBuilder.runWorkflow()">
            <i class="bi bi-play-fill"></i> Run
          </button>
          <button class="btn btn-sm btn-outline-secondary" onclick="toggleTheme()">
            <i class="bi bi-moon-stars-fill"></i>
          </button>
        </div>
      </div>

      <!-- Config Panel -->
      <div class="config-panel" id="configPanel">
        <button class="btn-close float-end" onclick="workflowBuilder.closeConfig()"></button>
        <h5 class="mb-4">Node Configuration</h5>
        <div id="configContent">
          <!-- Dynamic content based on selected node -->
        </div>
      </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Drawflow -->
    <script src="https://cdn.jsdelivr.net/npm/drawflow@0.0.59/dist/drawflow.min.js"></script>
    <!-- Structured Logger (must load before workflow-builder) -->
    <script src="js/utils/logger.js"></script>
    <!-- Workflow Builder JS -->
    <script src="js/workflow-builder.js"></script>
  </body>
</html>
