<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ollama Integration Test</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      .log-entry {
        font-family: monospace;
        margin: 2px 0;
        padding: 4px;
        border-radius: 3px;
      }
      .success {
        background-color: #d4edda;
      }
      .error {
        background-color: #f8d7da;
      }
      .info {
        background-color: #d1ecf1;
      }
      .warning {
        background-color: #fff3cd;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 5px;
        overflow-x: auto;
      }
    </style>
  </head>
  <body>
    <div class="container mt-5">
      <h1>Ollama Integration Test</h1>
      <p>This page tests the Ollama integration step by step to identify the issue.</p>

      <div class="mt-4">
        <button class="btn btn-primary" onclick="runAllTests()">Run All Tests</button>
        <button class="btn btn-secondary" onclick="clearLog()">Clear Log</button>
      </div>

      <div class="mt-4">
        <h3>Test Log:</h3>
        <div id="log" class="border rounded p-3"></div>
      </div>

      <div class="mt-4">
        <h3>Results:</h3>
        <pre id="results"></pre>
      </div>
    </div>

    <script>
      function log(message, type = 'info') {
        const logDiv = document.getElementById('log');
        const entry = document.createElement('div');
        entry.className = `log-entry ${type}`;
        entry.textContent = `${new Date().toISOString().substr(11, 12)} - ${message}`;
        logDiv.appendChild(entry);
        console.log(`[${type}] ${message}`);
      }

      function clearLog() {
        document.getElementById('log').innerHTML = '';
        document.getElementById('results').textContent = '';
      }

      async function test1_DirectOllama() {
        log('Test 1: Direct Ollama API', 'info');
        try {
          const response = await fetch('http://localhost:11434/api/tags');
          log(
            `Ollama direct response: ${response.status} ${response.statusText}`,
            response.ok ? 'success' : 'error'
          );

          if (response.ok) {
            const data = await response.json();
            log(`Found ${data.models?.length || 0} models`, 'success');
            return { success: true, models: data.models?.length || 0 };
          }
          return { success: false, error: `Status ${response.status}` };
        } catch (error) {
          log(`Ollama direct error: ${error.message}`, 'error');
          return { success: false, error: error.message };
        }
      }

      async function test2_BackendOllama() {
        log('Test 2: Backend Ollama endpoint', 'info');
        try {
          const response = await fetch('http://localhost:8000/api/ollama/models');
          log(
            `Backend response: ${response.status} ${response.statusText}`,
            response.ok ? 'success' : 'error'
          );

          const text = await response.text();
          log(`Response length: ${text.length} bytes`, 'info');

          if (response.ok) {
            const data = JSON.parse(text);
            log(`Backend available: ${data.available}`, data.available ? 'success' : 'warning');
            log(`Models: ${data.models?.length || 0}`, 'info');

            // Show the full response
            document.getElementById('results').textContent = JSON.stringify(data, null, 2);

            return { success: true, data };
          }
          return { success: false, error: `Status ${response.status}: ${text}` };
        } catch (error) {
          log(`Backend error: ${error.message}`, 'error');
          return { success: false, error: error.message };
        }
      }

      async function test3_FrontendOllama() {
        log('Test 3: Frontend loadOllamaModels simulation', 'info');

        // Simulate the frontend code
        const statusBadge = { textContent: '', className: '' };
        const modelSelect = { innerHTML: '', disabled: true };

        try {
          statusBadge.textContent = 'Connecting...';
          log('Status: Connecting...', 'info');

          const controller = new AbortController();
          const timeoutId = setTimeout(() => controller.abort(), 10000);

          const response = await fetch('http://localhost:8000/api/ollama/models', {
            method: 'GET',
            headers: {
              Accept: 'application/json',
              'Content-Type': 'application/json',
            },
            signal: controller.signal,
          });

          clearTimeout(timeoutId);

          log(`Frontend fetch status: ${response.status}`, response.ok ? 'success' : 'error');

          if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
          }

          const data = await response.json();

          if (data.available && data.models && data.models.length > 0) {
            statusBadge.textContent = `${data.models.length} models`;
            log(`Success: ${data.models.length} models loaded`, 'success');
            return { success: true, models: data.models.length };
          } else {
            statusBadge.textContent = 'Not Running';
            log('Ollama not running', 'warning');
            return { success: false, reason: 'not running' };
          }
        } catch (error) {
          log(`Frontend simulation error: ${error.message}`, 'error');

          if (error.name === 'AbortError') {
            statusBadge.textContent = 'Timeout';
            return { success: false, error: 'timeout' };
          } else {
            statusBadge.textContent = 'Error';
            return { success: false, error: error.message };
          }
        }
      }

      async function test4_ErrorScenario() {
        log('Test 4: Reproduce user error scenario', 'info');

        // This simulates what might be happening in the user's case
        try {
          // First, let's see if there's any console error
          window.addEventListener('error', (event) => {
            log(`Global error caught: ${event.message}`, 'error');
          });

          // Try to reproduce the exact conditions
          const response = await fetch('http://localhost:8000/api/ollama/models');

          // Check if response is JSON
          const contentType = response.headers.get('content-type');
          log(`Content-Type: ${contentType}`, 'info');

          if (!contentType || !contentType.includes('application/json')) {
            log('Response is not JSON!', 'error');
            const text = await response.text();
            log(`Raw response: ${text.substring(0, 200)}...`, 'error');
            return { success: false, error: 'Invalid response format' };
          }

          return { success: true };
        } catch (error) {
          log(`Test 4 error: ${error.name} - ${error.message}`, 'error');

          // This is likely what the user sees
          const statusText = error.name === 'TypeError' ? 'Error' : error.message;
          log(`User would see: "${statusText}"`, 'warning');

          return { success: false, userSeesError: statusText };
        }
      }

      async function runAllTests() {
        clearLog();
        log('Starting Ollama integration tests...', 'info');

        const results = {
          directOllama: await test1_DirectOllama(),
          backendOllama: await test2_BackendOllama(),
          frontendSimulation: await test3_FrontendOllama(),
          errorScenario: await test4_ErrorScenario(),
        };

        log('All tests completed', 'info');

        // Summary
        const summary = document.createElement('div');
        summary.className = 'mt-3 p-3 border rounded';
        summary.innerHTML = `
                <h4>Summary:</h4>
                <ul>
                    <li>Direct Ollama: ${results.directOllama.success ? '✓ Working' : '✗ Failed'}</li>
                    <li>Backend API: ${results.backendOllama.success ? '✓ Working' : '✗ Failed'}</li>
                    <li>Frontend Code: ${results.frontendSimulation.success ? '✓ Working' : '✗ Failed'}</li>
                    <li>Error Scenario: ${results.errorScenario.success ? '✓ No issues' : '✗ Reproduced'}</li>
                </ul>
                ${results.errorScenario.userSeesError ? `<p class="text-danger">User sees: "${results.errorScenario.userSeesError}"</p>` : ''}
            `;
        document.getElementById('log').appendChild(summary);
      }

      // Run tests automatically after 1 second
      setTimeout(runAllTests, 1000);
    </script>
  </body>
</html>
